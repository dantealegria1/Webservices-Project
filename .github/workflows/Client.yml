name: Verify Angular Client

on:
  workflow_dispatch:   # run manually
  push:
    branches: [ Parcial01-Dante ]

jobs:
  test-client:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    # --- Setup backend (.NET API) ---
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '9.0.x'

    - name: Restore backend
      run: dotnet restore DatingApp.sln

    - name: Build backend
      run: dotnet build API/API.csproj --no-restore --configuration Release

    - name: Apply EF Core migrations
      run: |
        cd API
        dotnet tool install --global dotnet-ef
        export PATH="$PATH:$HOME/.dotnet/tools"
        dotnet ef database update
        cd ..

    - name: Run backend in background
      run: |
        dotnet run --project API/API.csproj --urls "http://localhost:5001" &
        sleep 10

    # --- Setup frontend (Angular) ---
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Install Angular CLI
      run: npm install -g @angular/cli

    - name: Install dependencies
      working-directory: client
      run: npm ci

    - name: Run Angular unit tests
      working-directory: client
      run: ng test --watch=false --browsers=ChromeHeadless

    # --- Optional: End-to-End tests ---
    - name: Run Angular e2e tests
      working-directory: client
      run: ng e2e
